// base.js
var redis = require("redis")
var oauth = require("oauth")
var util = require("./util.js")

function base(req, res){
	tpl_val = {}
	res.render("index", tpl_val)
}

var login = {
	go: function go(req, res){
		url = util.oauth.getAuthorizeUrl({
			response_type:"code", state:"foobar",
			redirect_uri: "http://localhost:3000/back"})
		res.redirect(url)
	},
	back: function back(req, res){
		util.oauth.getOAuthAccessToken(req.query.code, {
				grant_type:'authorization_code',
				redirect_uri:'http://localhost:3000/back'
			},function(err, access_token, refresh_token, result){
				if(err) return res.redirect('/?oops')
				req.session.access_token = access_token
				console.log(result)
				res.redirect('/')
			}
		)
	}
}

this.setup = function setup(app){
	app.get('/', base)
	app.get('/login', login.go)
	app.get('/back',  login.back)
}
